apiVersion: v1
kind: ConfigMap
metadata:
  name: bank-init-sql
data:
  01-init-schemas.sql: |
    -- init-db/01-init-schemas.sql (kept in sync with init-db/01-init-schemas.sql)
    DROP SCHEMA IF EXISTS accounts      CASCADE;
    DROP SCHEMA IF EXISTS cash          CASCADE;
    DROP SCHEMA IF EXISTS transfer      CASCADE;
    DROP SCHEMA IF EXISTS exchange      CASCADE;
    DROP SCHEMA IF EXISTS blocker       CASCADE;
    DROP SCHEMA IF EXISTS notifications CASCADE;

    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    CREATE SCHEMA IF NOT EXISTS accounts;
    CREATE SCHEMA IF NOT EXISTS cash;
    CREATE SCHEMA IF NOT EXISTS transfer;
    CREATE SCHEMA IF NOT EXISTS exchange;
    CREATE SCHEMA IF NOT EXISTS blocker;
    CREATE SCHEMA IF NOT EXISTS notifications;

    CREATE TABLE accounts.users (
      id         UUID PRIMARY KEY,
      login      VARCHAR(50)  NOT NULL UNIQUE,
      name       VARCHAR(255) NOT NULL,
      email      VARCHAR(100),
      birthdate  DATE         NOT NULL,
      kc_id      VARCHAR(255),
      active     BOOLEAN      NOT NULL DEFAULT TRUE,
      created_at TIMESTAMPTZ  NOT NULL DEFAULT now(),
      updated_at TIMESTAMPTZ  NOT NULL DEFAULT now()
    );

    CREATE TABLE accounts.bank_accounts (
      id              UUID PRIMARY KEY,
      user_id         UUID        NOT NULL,
      account_number  VARCHAR(20) NOT NULL UNIQUE,
      currency        VARCHAR(3)  NOT NULL DEFAULT 'RUB',
      balance         NUMERIC(19,4) NOT NULL DEFAULT 0,
      status          VARCHAR(20) NOT NULL DEFAULT 'ACTIVE',
      version         BIGINT      NOT NULL DEFAULT 0,
      created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
      CONSTRAINT fk_bank_accounts_user FOREIGN KEY (user_id)
        REFERENCES accounts.users(id) ON DELETE CASCADE,
      CONSTRAINT uq_bank_accounts_user_currency UNIQUE (user_id, currency),
      CONSTRAINT chk_balance_nonneg CHECK (balance >= 0),
      CONSTRAINT chk_currency3 CHECK (char_length(currency) = 3)
    );
    CREATE INDEX idx_bank_accounts_user_id ON accounts.bank_accounts(user_id);

    CREATE TABLE exchange.exchange_rates (
      id               BIGSERIAL PRIMARY KEY,
      base_currency    VARCHAR(3)    NOT NULL,
      currency         VARCHAR(3)    NOT NULL,
      buy_rate         NUMERIC(20,4) NOT NULL,
      sell_rate        NUMERIC(20,4) NOT NULL,
      updated_at       TIMESTAMPTZ   NOT NULL DEFAULT now(),
      CONSTRAINT uq_exchange_pair     UNIQUE (base_currency, currency),
      CONSTRAINT chk_base_cur3        CHECK (char_length(base_currency) = 3),
      CONSTRAINT chk_target_cur3      CHECK (char_length(currency) = 3),
      CONSTRAINT chk_buy_positive     CHECK (buy_rate > 0),
      CONSTRAINT chk_sell_positive    CHECK (sell_rate > 0)
    );

    CREATE TABLE transfer.transactions (
      id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      from_account_id  UUID        NOT NULL,
      to_account_id    UUID        NOT NULL,
      amount           NUMERIC(19,4) NOT NULL,
      currency         VARCHAR(3)  NOT NULL,
      status           VARCHAR(20) NOT NULL DEFAULT 'PENDING',
      idempotency_key  VARCHAR(100) NOT NULL,
      created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
      version          BIGINT      NOT NULL DEFAULT 0,
      CONSTRAINT chk_transfer_amount    CHECK (amount > 0),
      CONSTRAINT chk_transfer_currency3 CHECK (char_length(currency) = 3),
      CONSTRAINT uq_transfer_idempotency UNIQUE (idempotency_key)
    );
    CREATE INDEX idx_transactions_from_account ON transfer.transactions(from_account_id);
    CREATE INDEX idx_transactions_to_account   ON transfer.transactions(to_account_id);

    CREATE TABLE cash.operations (
      id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      account_id       UUID        NOT NULL,
      operation_type   VARCHAR(20) NOT NULL,
      amount           NUMERIC(19,4) NOT NULL,
      currency         VARCHAR(3)  NOT NULL,
      status           VARCHAR(20) NOT NULL DEFAULT 'PENDING',
      idempotency_key  VARCHAR(100) NOT NULL,
      created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
      updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
      version          BIGINT      NOT NULL DEFAULT 0,
      CONSTRAINT chk_cash_amount     CHECK (amount > 0),
      CONSTRAINT chk_cash_currency3  CHECK (char_length(currency) = 3),
      CONSTRAINT uq_cash_idempotency UNIQUE (idempotency_key)
    );
    CREATE INDEX idx_operations_account ON cash.operations(account_id);

    CREATE TABLE blocker.suspicious_operations (
      id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      operation_id    UUID        NOT NULL,
      operation_type  VARCHAR(50) NOT NULL,
      reason          VARCHAR(255) NOT NULL,
      status          VARCHAR(20)  NOT NULL DEFAULT 'OPEN',
      created_at      TIMESTAMPTZ  NOT NULL DEFAULT now()
    );

    CREATE TABLE notifications.messages (
      id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      user_id     UUID        NOT NULL,
      type        VARCHAR(50) NOT NULL,
      title       VARCHAR(255) NOT NULL,
      content     TEXT        NOT NULL,
      status      VARCHAR(20) NOT NULL DEFAULT 'PENDING',
      created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
      sent_at     TIMESTAMPTZ
    );
    CREATE INDEX idx_messages_user ON notifications.messages(user_id);

    INSERT INTO exchange.exchange_rates (base_currency, currency, buy_rate, sell_rate)
    VALUES ('RUB','RUB',1.0000,1.0000),
           ('RUB','USD',0.0110,0.0110),
           ('RUB','CNY',0.0790,0.0790),
           ('USD','RUB',90.9100,90.9100),
           ('USD','CNY',7.1800,7.1800),
           ('CNY','RUB',12.6600,12.6600),
           ('CNY','USD',0.1390,0.1390)
    ON CONFLICT (base_currency, currency) DO NOTHING;

    WITH upsert_bob AS (
        INSERT INTO accounts.users (id, login, name, email, birthdate, kc_id, active, created_at, updated_at)
        VALUES (gen_random_uuid(), 'bob', 'Bob Example', 'bob@example.com', DATE '1990-01-10', NULL, TRUE, now(), now())
        ON CONFLICT (login) DO UPDATE
            SET name = EXCLUDED.name,
                email = EXCLUDED.email,
                birthdate = EXCLUDED.birthdate,
                active = TRUE,
                updated_at = now()
        RETURNING id
    )
    INSERT INTO accounts.bank_accounts (id, user_id, account_number, currency, balance, status, version, created_at, updated_at)
    SELECT gen_random_uuid(), id, '40800000000000000001', 'RUB', 1500.00, 'ACTIVE', 0, now(), now()
    FROM upsert_bob
    ON CONFLICT (user_id, currency) DO UPDATE
        SET balance = EXCLUDED.balance,
            status = EXCLUDED.status,
            updated_at = now();

    WITH upsert_alice AS (
        INSERT INTO accounts.users (id, login, name, email, birthdate, kc_id, active, created_at, updated_at)
        VALUES (gen_random_uuid(), 'alice', 'Alice Example', 'alice@example.com', DATE '1992-05-15', NULL, TRUE, now(), now())
        ON CONFLICT (login) DO UPDATE
            SET name = EXCLUDED.name,
                email = EXCLUDED.email,
                birthdate = EXCLUDED.birthdate,
                active = TRUE,
                updated_at = now()
        RETURNING id
    )
    INSERT INTO accounts.bank_accounts (id, user_id, account_number, currency, balance, status, version, created_at, updated_at)
    SELECT gen_random_uuid(), id, '40800000000000000002', 'RUB', 750.00, 'ACTIVE', 0, now(), now()
    FROM upsert_alice
    ON CONFLICT (user_id, currency) DO UPDATE
        SET balance = EXCLUDED.balance,
            status = EXCLUDED.status,
            updated_at = now();

    INSERT INTO accounts.bank_accounts (id, user_id, account_number, currency, balance, status, version, created_at, updated_at)
    SELECT gen_random_uuid(), id, '40800000000000000003', 'USD', 300.00, 'ACTIVE', 0, now(), now()
    FROM accounts.users WHERE login = 'bob'
    ON CONFLICT (user_id, currency) DO NOTHING;

    INSERT INTO accounts.bank_accounts (id, user_id, account_number, currency, balance, status, version, created_at, updated_at)
    SELECT gen_random_uuid(), id, '40800000000000000004', 'CNY', 500.00, 'ACTIVE', 0, now(), now()
    FROM accounts.users WHERE login = 'alice'
    ON CONFLICT (user_id, currency) DO NOTHING;

---
apiVersion: batch/v1
kind: Job
metadata:
  name: bank-init-db
spec:
  backoffLimit: 1
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: psql
          image: postgres:16-alpine
          env:
            - name: PGHOST
              value: bank-postgres
            - name: PGUSER
              value: bank
            - name: PGPASSWORD
              value: bank123
            - name: PGDATABASE
              value: bank
          volumeMounts:
            - name: init-sql
              mountPath: /scripts
          command: ["psql", "-f", "/scripts/01-init-schemas.sql"]
      volumes:
        - name: init-sql
          configMap:
            name: bank-init-sql
